<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BeyondDEX — Affiliate Program</title>
  <meta name="description" content="Apply to the BeyondDEX affiliate program and earn 30% recurring revenue for every referral." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="/favicon.ico" />

  <!-- Tiny safety so [hidden] is respected even if CSS gets overridden -->
  <style>
    .profile-menu[hidden], .auth-links[hidden], #mobileAuthLinks[hidden], #userMenu[hidden] { display: none !important; }
    /* Affiliate page scoped tweaks in case style.css doesn't have them yet */
    .page-affiliate main.affiliate { padding: clamp(3rem, 6vw, 6rem) 0; }
    .page-affiliate .form.card { max-width: 860px; margin-inline: auto; display: grid; gap: 1rem; }
    .page-affiliate .form.card label { display: grid; gap: .4rem; font-weight: 600; }
    .page-affiliate .form.card .actions { display: flex; gap: .6rem; justify-content: flex-end; margin-top: .2rem; }
    .page-affiliate input, .page-affiliate textarea, .page-affiliate select {
      width: 100%; padding: .9rem 1rem; border-radius: 14px; border: 1px solid var(--border);
      background: var(--bg-soft); color: var(--text); box-shadow: var(--shadow);
    }
    .page-affiliate textarea { min-height: 120px; resize: vertical; }
    .page-affiliate .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 860px) {
      .page-affiliate .grid-2 { grid-template-columns: 1fr; }
      .page-affiliate .auth-links { display: none !important; } /* keep header uncluttered on mobile */
    }
  </style>
</head>
<body class="page-affiliate">
  <!-- ====== NAV (same header) ====== -->
  <header class="nav">
    <div class="container nav__inner">
      <a href="/index.html#home" class="brand">
        <img src="/assets/bdx.png" alt="BeyondDEX logo" class="brand__logo logo--light" />
        <img src="/assets/bdx-white.png" alt="BeyondDEX logo" class="brand__logo logo--dark" />
        <span class="brand__name">BeyondDEX</span>
      </a>

      <nav class="nav__links" aria-label="Primary">
        <a href="/index.html#home">Home</a>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/affiliateSignUp.html">Affiliate</a>
      </nav>

      <div class="nav__actions">
        <button class="btn btn--ghost" id="themeToggle" aria-label="Toggle theme">☾</button>

        <!-- Shown when logged OUT -->
        <span id="authLinks" class="auth-links">
          <a href="#login" id="hdrLogin" class="auth-link">Login</a>
          <span class="dot">•</span>
          <a href="#register" id="hdrRegister" class="auth-link">Register</a>
        </span>

        <!-- Shown when logged IN -->
        <div id="userMenu" class="profile-wrapper" hidden>
          <button id="profileBtn" class="profile-circle" aria-haspopup="true" aria-expanded="false" aria-label="Open profile menu">U</button>
          <div id="profileMenu" class="profile-menu" hidden>
            <button id="logoutBtn" type="button">Log out</button>
          </div>
        </div>

        <a class="btn btn--primary" href="/affiliateSignUp.html">Join Waitlist</a>
      </div>

      <button class="nav__hamburger" id="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="nav__mobile" id="mobileMenu" hidden>
      <a href="/index.html#home">Home</a>
      <a href="/dashboard.html">Dashboard</a>
      <a href="/affiliateSignUp.html">Affiliate</a>
      <a class="btn btn--primary" href="/affiliateSignUp.html">Join Waitlist</a>
      <div id="mobileAuthLinks">
        <a href="#login" id="mLogin">Login</a>
        <a href="#register" id="mRegister">Register</a>
      </div>
    </div>
  </header>

  <!-- ====== MAIN ====== -->
  <main class="affiliate container">
    <header class="section__head">
      <h1>Become a BeyondDEX Affiliate</h1>
      <p class="sub">Earn <strong>30% recurring</strong> for every active referral. Apply in 60 seconds.</p>
    </header>

    <form id="affiliateForm" class="card form" novalidate>
      <div class="grid-2">
        <label>
          <span>Full name</span>
          <input name="name" type="text" required />
        </label>
        <label>
          <span>Email</span>
          <input name="email" type="email" required placeholder="you@protrader.xyz" />
        </label>
      </div>

      <div class="grid-2">
        <label>
          <span>Twitter / X</span>
        <input name="twitter" type="text" placeholder="@handle" />
        </label>
        <label>
          <span>Website (optional)</span>
          <input name="website" type="url" placeholder="https://…" />
        </label>
      </div>

      <label>
        <span>How will you promote BeyondDEX?</span>
        <textarea name="plan" required placeholder="Audience, channels, estimated reach, content ideas…"></textarea>
      </label>

      <div class="actions">
        <button class="btn btn--ghost" type="button" id="cancelAff">Cancel</button>
        <button class="btn btn--primary" type="submit" id="applyBtn">Apply</button>
      </div>
    </form>
  </main>

  <!-- ====== FOOTER ====== -->
  <footer class="footer">
    <div class="container footer__inner">
      <div class="footer__brand">
        <span class="brand__glyph">▱</span>
        <strong>BeyondDEX</strong>
      </div>
      <nav class="footer__links">
        <a href="/index.html#features">Features</a>
        <a href="/index.html#community">Community</a>
        <a href="/index.html#faq">FAQ</a>
        <a href="mailto:team@beyonddex.com">Contact</a>
      </nav>
      <p class="tiny">© <span id="year"></span> BeyondDEX. All rights reserved.</p>
    </div>
  </footer>

  <!-- ====== SCRIPTS ====== -->
  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Theme toggle
    const root = document.documentElement;
    const toggle = document.getElementById('themeToggle');
    const stored = localStorage.getItem('theme');
    if (stored) root.dataset.theme = stored;
    toggle.addEventListener('click', () => {
      const next = root.dataset.theme === 'light' ? 'dark' : 'light';
      root.dataset.theme = next;
      localStorage.setItem('theme', next);
      toggle.textContent = next === 'light' ? '☾' : '☀';
    });

    // Mobile nav
    const burger = document.getElementById('hamburger');
    const mobile = document.getElementById('mobileMenu');
    burger.addEventListener('click', () => {
      const open = mobile.hasAttribute('hidden') ? false : true;
      burger.setAttribute('aria-expanded', String(!open));
      mobile.toggleAttribute('hidden');
      document.body.classList.toggle('no-scroll');
    });
  </script>

  <script>
    // Firebase init (reuse if already initialized)
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyBbz_G9FNjS4cl0oi1221C3ZOACyZzEgK8",
        authDomain: "beyonddex-be653.firebaseapp.com",
        projectId: "beyonddex-be653",
        storageBucket: "beyonddex-be653.firebasestorage.app",
        messagingSenderId: "687411546401",
        appId: "1:687411546401:web:ec71401e52751d3e121660",
        measurementId: "G-6SH111LB7J"
      });
    }
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== Auth UI wiring (same behavior as index) =====
    const authLinks        = document.getElementById('authLinks');
    const mobileAuthLinks  = document.getElementById('mobileAuthLinks');
    const userMenu         = document.getElementById('userMenu');
    const profileBtn       = document.getElementById('profileBtn');
    const profileMenu      = document.getElementById('profileMenu');
    const logoutBtnEl      = () => document.getElementById('logoutBtn');

    function hide(el){ if (!el) return; el.hidden = true; el.style.display = 'none'; }
    function show(el, display=''){ if (!el) return; el.hidden = false; el.style.display = display; }

    function openProfileMenu(){ if (!profileMenu) return; profileMenu.removeAttribute('hidden'); profileBtn?.setAttribute('aria-expanded','true'); }
    function closeProfileMenu(){ if (!profileMenu) return; profileMenu.setAttribute('hidden',''); profileBtn?.setAttribute('aria-expanded','false'); }
    closeProfileMenu();

    function setLoggedOut(){ show(authLinks, 'inline-flex'); show(mobileAuthLinks, ''); hide(userMenu); closeProfileMenu(); }
    function setLoggedIn(initial){ hide(authLinks); hide(mobileAuthLinks); show(userMenu, ''); if (profileBtn && initial) profileBtn.textContent = initial; closeProfileMenu(); }

    profileBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (profileMenu?.hasAttribute('hidden')) openProfileMenu(); else closeProfileMenu();
    });
    document.addEventListener('click', (e) => {
      if (!profileBtn?.contains(e.target) && !profileMenu?.contains(e.target)) closeProfileMenu();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeProfileMenu(); });

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          const doc = await db.collection("users").doc(user.uid).get();
          const username = doc.exists ? (doc.data().username || 'U') : 'U';
          const initial  = String(username).charAt(0).toUpperCase() || 'U';
          setLoggedIn(initial);
        } catch (e) {
          console.error('[Auth] Failed to get user doc:', e);
          setLoggedIn('U');
        }
        const ensureLogout = () => {
          const btn = logoutBtnEl();
          if (btn && !btn.dataset.wired) {
            btn.dataset.wired = '1';
            btn.addEventListener('click', async () => {
              await auth.signOut();
              setLoggedOut();
              window.location.href = '/';
            });
          }
        };
        ensureLogout();
        profileBtn?.addEventListener('click', ensureLogout);
      } else {
        setLoggedOut();
      }
    });

    // Close mobile menu when navigating
    mobile?.querySelectorAll('a[href]').forEach(a => {
      a.addEventListener('click', () => {
        mobile.setAttribute('hidden', '');
        burger.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('no-scroll');
      });
    });
  </script>

  <script>
    // ===== Affiliate form submit -> Firestore create-only =====
    const form      = document.getElementById('affiliateForm');
    const applyBtn  = document.getElementById('applyBtn');
    const cancelBtn = document.getElementById('cancelAff');

    function valEmail(v){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const data = {
        name:   (fd.get('name')    || '').toString().trim(),
        email:  (fd.get('email')   || '').toString().trim().toLowerCase(),
        twitter:(fd.get('twitter') || '').toString().trim(),
        website:(fd.get('website') || '').toString().trim(),
        plan:   (fd.get('plan')    || '').toString().trim(),
        uid:    auth?.currentUser?.uid || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        source: 'affiliate-signup'
      };

      if (!data.name || !valEmail(data.email) || !data.plan) {
        alert('Please complete your name, a valid email, and your promotion plan.');
        return;
      }

      applyBtn.disabled = true; applyBtn.textContent = 'Submitting…';
      try {
        await db.collection('affiliate_applications').add(data);

        form.outerHTML = `
          <div class="card" style="position:relative;margin-top:.8rem;padding:1rem 3.25rem 1rem 1rem;
                                    border:1px solid var(--border);border-radius:14px;background:var(--card);
                                    box-shadow:var(--shadow)">
            <strong>✅ Application received.</strong>
            <div class="tiny" style="margin-top:.4rem;color:var(--muted);">
              We’ll review and send your unique referral link if approved.
            </div>
            <button id="resetAff"
                    aria-label="Close and reset"
                    title="Done"
                    style="position:absolute;right:.6rem;bottom:.6rem;width:36px;height:36px;
                           border-radius:50%;border:1px solid var(--border);background:var(--bg-soft);
                           color:var(--text);display:grid;place-items:center;font-weight:800;
                           cursor:pointer;box-shadow:var(--shadow);">✓</button>
          </div>`;
        document.getElementById('resetAff')?.addEventListener('click', () => window.location.reload());
      } catch (err) {
        console.error('[Affiliate] submit error:', err);
        applyBtn.disabled = false; applyBtn.textContent = 'Apply';
        alert('Sorry—something went wrong. Please try again.');
      }
    });

    cancelBtn?.addEventListener('click', () => window.location.href = '/');
  </script>
</body>
</html>
