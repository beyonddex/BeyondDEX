<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Economic Calendar | BeyondDEX</title>
  <link rel="stylesheet" href="css/calendar.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <div class="logo-container">
    <a href="index.html"><img src="assets/bdx.png" alt="BeyondDEX Logo" /></a>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="dex.html">DEX</a>
      <a href="dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div class="user-container">
    <div class="user-circle" id="userCircle" style="display: none;">?</div>
    <div class="dropdown" id="dropdownMenu" style="display: none;">
      <a href="#" id="logout">Log Out</a>
    </div>
  </div>
</header>

<div class="main-content">
  <!-- Left Navigation -->
  <div class="left-nav">
    <a href="dashboard.html" class="nav-link" title="Dashboard">
      <img src="assets/dashboard.png" alt="Dashboard" class="nav-icon" />
    </a>
    <a href="calendar.html" class="nav-link" title="Calendar">
      <img src="assets/calendar.png" alt="Calendar" class="nav-icon" />
    </a>
    <a href="wallet-analytics.html" class="nav-link active" title="Wallet Analytics">
      <img src="assets/wallet.png" alt="Wallet Analytics" class="nav-icon" />
    </a>
  </div>

  <div class="calendar-section">
    <div class="calendar-box">
      <h2 style="margin-bottom: 20px;">Full Economic Calendar</h2>
      <ul id="econCalendarList"></ul>
    </div>
  </div>

  <aside class="sidebar">
    <div id="onlineUsersCount">Online Users: 0</div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type a message..." />
      <button id="sendMessage">Send</button>
    </div>
  </aside>
</div>

<footer>
  Â© 2025 BeyondDEX. All rights reserved.<br />
  <a href="mailto:team@beyonddex.io">team@beyonddex.io</a>
</footer>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBbz_G9FNjS4cl0oi1221C3ZOACyZzEgK8",
    authDomain: "beyonddex-be653.firebaseapp.com",
    projectId: "beyonddex-be653",
    storageBucket: "beyonddex-be653.firebasestorage.app",
    messagingSenderId: "687411546401",
    appId: "1:687411546401:web:ec71401e52751d3e121660",
    measurementId: "G-6SH111LB7J"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const userCircle = document.getElementById("userCircle");
  const dropdownMenu = document.getElementById("dropdownMenu");


  let currentUsername = '';
  let userDocId = '';
  let onlineUserMap = {};


  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendMessage = document.getElementById("sendMessage");
  const onlineUsersCount = document.getElementById("onlineUsersCount");

  function updatePresence(uid, username) {
    userDocId = uid;
    db.collection("presence").doc(uid).set({
      username,
      lastActive: firebase.firestore.Timestamp.now()
    }, { merge: true });
  }

  function monitorPresence() {
  setInterval(() => {
    if (userDocId && currentUsername) {
      updatePresence(userDocId, currentUsername);
    }
  }, 30000);

  db.collection("presence").onSnapshot(snapshot => {
    const now = Date.now();
    onlineUserMap = {};

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const lastActive = data.lastActive?.toDate().getTime();
      if (lastActive) {
        const isOnline = now - lastActive < 3 * 60 * 1000;
        onlineUserMap[doc.id] = {
          username: data.username,
          isOnline
        };
      }
    });

    onlineUsersCount.textContent = `Online Users: ${
      Object.values(onlineUserMap).filter(u => u.isOnline).length
    }`;

    renderChatMessages(); // âœ… refresh chat with presence dots
  });
}
function renderChatMessages() {
  db.collection("chat").orderBy("timestamp").get().then(snapshot => {
    chatBox.innerHTML = "";
    snapshot.forEach(doc => {
      const { username, text, timestamp } = doc.data();
      const timeStr = timestamp ? getRelativeTime(timestamp) : "";

      let isOnline = false;
      for (let uid in onlineUserMap) {
        if (onlineUserMap[uid].username === username) {
          isOnline = onlineUserMap[uid].isOnline;
          break;
        }
      }

      const statusDot = `<span style="
        display:inline-block;
        width:8px;
        height:8px;
        margin-right:6px;
        border-radius:50%;
        background-color:${isOnline ? '#22c55e' : '#9ca3af'};
        box-shadow:${isOnline ? '0 0 8px #22c55e' : 'none'};
      "></span>`;

      const div = document.createElement("div");
      div.className = "chat-message";
      div.innerHTML = `${statusDot}<strong>${username}</strong> <span style="color: gray; font-size: 12px;">${timeStr}</span>: ${text}`;
      chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

  auth.onAuthStateChanged(user => {
    if (user) {
      const uid = user.uid;
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          const username = doc.data().username || user.email || "Anon";
          currentUsername = username;
          userDocId = uid;
          updatePresence(uid, username);
          monitorPresence();

          // âœ… Show user circle
          userCircle.style.display = "flex";
          userCircle.textContent = username.charAt(0).toUpperCase();
        }
      });

      db.collection("chat").orderBy("timestamp").onSnapshot(() => {
  renderChatMessages();
});

    } else {
      window.location.href = "/auth.html";
    }
  });

  function sendChatMessage() {
    const message = chatInput.value.trim();
    if (message) {
      db.collection("chat").add({
        username: currentUsername,
        text: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      chatInput.value = "";
      chatInput.focus();
    }
  }

  sendMessage.addEventListener("click", sendChatMessage);
  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendChatMessage();
  });

  function getRelativeTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp.toDate().getTime();
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return "just now";
    if (minutes < 60) return `${minutes} min ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hr${hours > 1 ? 's' : ''} ago`;
    return timestamp.toDate().toLocaleDateString();
  }

  async function loadCalendar() {
    const res = await fetch('https://beyonddex-backend.onrender.com/api/calendar');
    const events = await res.json();
    renderCalendar(events);
  }

  const countryCodeMap = {
  'United States': 'US',
  'Canada': 'CA',
  'Australia': 'AU',
  'Germany': 'DE',
  'France': 'FR',
  'United Kingdom': 'GB',
  'Japan': 'JP',
  'China': 'CN',
  'Switzerland': 'CH',
  'South Korea': 'KR',
  'New Zealand': 'NZ',
  'Italy': 'IT',
  'Spain': 'ES',
  'India': 'IN',
  'Brazil': 'BR',
  'Russia': 'RU',
'Mexico': 'MX',
'Norway': 'NO',
'Netherlands': 'NL',
'Turkey': 'TR',
'Euro Zone': 'EU',
'European Union': 'EU',
'Hong Kong': 'HK',
'Singapore': 'SG',
'United Arab Emirates': 'AE',
'Saudi Arabia': 'SA',
'Argentina': 'AR',
'Indonesia': 'ID',
'South Africa': 'ZA',
'Philippines': 'PH',
'Thailand': 'TH',
'Malaysia': 'MY',
'Sweden': 'SE',
'Denmark': 'DK',
  // Add more mappings as needed
};

function renderCalendar(events) {
  const ul = document.getElementById('econCalendarList');
  ul.innerHTML = '';
  let lastDate = '';

events.sort((a, b) => new Date(a.date) - new Date(b.date));

  events.forEach(e => {
    if (e.date !== lastDate) {
      const dateLi = document.createElement('li');
      dateLi.innerHTML = `<h3>${new Date(e.date).toLocaleDateString(undefined, {
        weekday: 'long', month: 'long', day: 'numeric'
      })}</h3>`;
      ul.appendChild(dateLi);
      lastDate = e.date;
    }

    const impactClass = e.impact?.toLowerCase() ? `impact-${e.impact.toLowerCase()}` : '';
    const countryCode = countryCodeMap[e.country] || e.country || 'UN';
    const flagURL = `https://flagcdn.com/24x18/${countryCode.toLowerCase()}.png`;

    const li = document.createElement('li');
    li.className = 'economic-event';
    li.innerHTML = `
      <span class="event-time">${e.time || ''}</span>
      <span class="event-info">
        <img class="flag" src="${flagURL}" alt="${e.country}" onerror="this.style.display='none'">
        <span class="event-name">${e.event}</span>
      </span>
      <span class="${impactClass}">${e.impact || ''}</span>
    `;
    ul.appendChild(li);
  });
}

  window.addEventListener('DOMContentLoaded', loadCalendar);

  // ðŸ”» Logout dropdown toggle behavior
userCircle.addEventListener("click", () => {
  dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
});

window.addEventListener("click", (e) => {
  if (!userCircle.contains(e.target) && !dropdownMenu.contains(e.target)) {
    dropdownMenu.style.display = "none";
  }
});

document.getElementById("logout").addEventListener("click", () => {
  if (userDocId) {
    db.collection("presence").doc(userDocId).delete();
  }
  auth.signOut().then(() => window.location.href = "/auth.html");
});

</script>

</body>
</html>
