<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wallet Analytics | BeyondDEX</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/wallet-analytics.css" />
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="page-wrapper">
<!-- Header -->
<header>
  <div class="logo-container">
    <a href="/"><img src="assets/bdx.png" alt="BeyondDEX Logo" /></a>
    <div class="nav-links">
      <a href="/index.html">Home</a>
      <a href="/dex.html">DEX</a>
      <a href="/dashboard.html">Dashboard</a>
    </div>
  </div>
  <div class="user-container">
    <div class="user-circle" id="userCircle">?</div>
    <div class="dropdown" id="dropdownMenu">
      <a href="#" id="logout">Log Out</a>
    </div>
  </div>
</header>

<div class="dashboard-content">
  <!-- Left Navigation -->
  <div class="left-nav">
    <a href="dashboard.html" class="nav-link" title="Dashboard">
      <img src="assets/dashboard.png" alt="Dashboard" class="nav-icon" />
    </a>
    <a href="calendar.html" class="nav-link" title="Calendar">
      <img src="assets/calendar.png" alt="Calendar" class="nav-icon" />
    </a>
    <a href="wallet-analytics.html" class="nav-link active" title="Wallet Analytics">
      <img src="assets/wallet.png" alt="Wallet Analytics" class="nav-icon" />
    </a>
  </div>

  <!-- Main Flex -->
  <div class="main-flex">
    <!-- Wallet Columns -->
    <div class="wallet-content">
      <!-- Left Column -->
      <div class="column">
        <div class="card">
          <h4>Wallet Snapshot</h4>
          <p><strong>Address:</strong> <span id="walletAddress">0x...</span></p>
          <p><strong>First Tx:</strong> <span id="firstTx">Loading...</span></p>
          <p><strong>Whale:</strong> <span id="isWhale">No</span></p>
          <p><strong>Wallet Type:</strong> <span id="walletType">Loading...</span></p>
        </div>
        <div class="card">
          <h4>Smart Alerts</h4>
          <label><input type="checkbox" id="alertCheckbox"> Notify on > $10K trades</label>
          <button style="margin-top:10px;">Export Report</button>
        </div>
      </div>

      <!-- Middle Column -->
      <div class="column" style="flex:2;">
        <div class="wallet-header">
          <input type="text" id="walletSearch" placeholder="Enter Wallet Address..." />
          <button id="analyzeWallet">Analyze</button>
        </div>
        <div class="card">
          <h4>Total Portfolio Value</h4>
          <p style="font-size:24px; font-weight:bold;">$<span id="walletTotalValue">0</span></p>
        </div>
        <div class="card">
          <h4>PnL (20d)</h4>
          <p><span id="walletPnL">Loading...</span></p>
        </div>
        <div class="card">
          <h4>PnL by Asset</h4>
          <ul id="pnlByAssetList"></ul>
        </div>
        <div class="card">
          <h4>Strategy Insights</h4>
          <p id="strategyInsights">Loading wallet strategy...</p>
        </div>
      </div>

      <!-- Right Column -->
      <div class="column">
        <div class="card">
          <h4>Performance Analytics</h4>
          <div class="placeholder-graph">Graph Placeholder</div>
        </div>
        <div class="card">
          <h4>Wallet Correlation Map</h4>
          <div class="placeholder-graph">Correlation Network</div>
        </div>
      </div>
    </div>

    <!-- Sidebar Chat -->
    <aside class="sidebar">
    <div id="onlineUsersCount">Online Users: 0</div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type a message..." />
      <button id="sendMessage">Send</button>
    </div>
  </aside>
  </div>
</div>

<footer>Â© 2025 BeyondDEX. All rights reserved.</footer>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBbz_G9FNjS4cl0oi1221C3ZOACyZzEgK8",
    authDomain: "beyonddex-be653.firebaseapp.com",
    projectId: "beyonddex-be653",
    storageBucket: "beyonddex-be653.firebasestorage.app",
    messagingSenderId: "687411546401",
    appId: "1:687411546401:web:ec71401e52751d3e121660",
    measurementId: "G-6SH111LB7J"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const userCircle = document.getElementById("userCircle");
  const dropdownMenu = document.getElementById("dropdownMenu");


  let currentUsername = '';
  let userDocId = '';
  let onlineUserMap = {};


  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendMessage = document.getElementById("sendMessage");
  const onlineUsersCount = document.getElementById("onlineUsersCount");

  function updatePresence(uid, username) {
    userDocId = uid;
    db.collection("presence").doc(uid).set({
      username,
      lastActive: firebase.firestore.Timestamp.now()
    }, { merge: true });
  }

  function monitorPresence() {
  setInterval(() => {
    if (userDocId && currentUsername) {
      updatePresence(userDocId, currentUsername);
    }
  }, 30000);

  db.collection("presence").onSnapshot(snapshot => {
    const now = Date.now();
    onlineUserMap = {};

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const lastActive = data.lastActive?.toDate().getTime();
      if (lastActive) {
        const isOnline = now - lastActive < 3 * 60 * 1000;
        onlineUserMap[doc.id] = {
          username: data.username,
          isOnline
        };
      }
    });

    onlineUsersCount.textContent = `Online Users: ${
      Object.values(onlineUserMap).filter(u => u.isOnline).length
    }`;

    renderChatMessages(); // âœ… refresh chat with presence dots
  });
}
function renderChatMessages() {
  db.collection("chat").orderBy("timestamp").get().then(snapshot => {
    chatBox.innerHTML = "";
    snapshot.forEach(doc => {
      const { username, text, timestamp } = doc.data();
      const timeStr = timestamp ? getRelativeTime(timestamp) : "";

      let isOnline = false;
      for (let uid in onlineUserMap) {
        if (onlineUserMap[uid].username === username) {
          isOnline = onlineUserMap[uid].isOnline;
          break;
        }
      }

      const statusDot = `<span style="
        display:inline-block;
        width:8px;
        height:8px;
        margin-right:6px;
        border-radius:50%;
        background-color:${isOnline ? '#22c55e' : '#9ca3af'};
        box-shadow:${isOnline ? '0 0 8px #22c55e' : 'none'};
      "></span>`;

      const div = document.createElement("div");
      div.className = "chat-message";
      div.innerHTML = `${statusDot}<strong>${username}</strong> <span style="color: gray; font-size: 12px;">${timeStr}</span>: ${text}`;
      chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

  auth.onAuthStateChanged(user => {
    if (user) {
      const uid = user.uid;
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          const username = doc.data().username || user.email || "Anon";
          currentUsername = username;
          userDocId = uid;
          updatePresence(uid, username);
          monitorPresence();

          // âœ… Show user circle
          userCircle.style.display = "flex";
          userCircle.textContent = username.charAt(0).toUpperCase();
        }
      });

      db.collection("chat").orderBy("timestamp").onSnapshot(() => {
  renderChatMessages();
});

    } else {
      window.location.href = "/auth.html";
    }
  });

  function sendChatMessage() {
    const message = chatInput.value.trim();
    if (message) {
      db.collection("chat").add({
        username: currentUsername,
        text: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      chatInput.value = "";
      chatInput.focus();
    }
  }

  sendMessage.addEventListener("click", sendChatMessage);
  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendChatMessage();
  });

  function getRelativeTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp.toDate().getTime();
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return "just now";
    if (minutes < 60) return `${minutes} min ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hr${hours > 1 ? 's' : ''} ago`;
    return timestamp.toDate().toLocaleDateString();
  }

  // ðŸ”» Logout dropdown toggle behavior
userCircle.addEventListener("click", () => {
  dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
});

window.addEventListener("click", (e) => {
  if (!userCircle.contains(e.target) && !dropdownMenu.contains(e.target)) {
    dropdownMenu.style.display = "none";
  }
});

document.getElementById("logout").addEventListener("click", () => {
  if (userDocId) {
    db.collection("presence").doc(userDocId).delete();
  }
  auth.signOut().then(() => window.location.href = "/auth.html");
});

//WALLET ITEMS
document.getElementById('analyzeWallet').addEventListener('click', async () => {
  const wallet = document.getElementById('walletSearch').value.trim();
  if (!wallet) return alert('Enter a wallet address');

  // Show loading states
  document.getElementById('walletAddress').textContent = 'Loading...';
  document.getElementById('firstTx').textContent = 'Loading...';
  document.getElementById('walletType').textContent = 'Loading...';
  document.getElementById('isWhale').textContent = 'Loading...';
  document.getElementById('walletTotalValue').textContent = '...';
  document.getElementById('walletPnL').textContent = 'Loading...';
  document.getElementById('strategyInsights').textContent = 'Analyzing wallet strategy...';
  document.getElementById('pnlByAssetList').innerHTML = '<li>Loading...</li>';

  try {
    // âœ… Wallet Snapshot
    const snapshotRes = await fetch(`/api/wallet/${wallet}`);
    const snapshot = await snapshotRes.json();

    document.getElementById('walletAddress').textContent = snapshot.address || 'N/A';
    document.getElementById('firstTx').textContent =
      snapshot.firstTransaction ? new Date(snapshot.firstTransaction).toLocaleDateString() : 'N/A';
    document.getElementById('walletType').textContent = snapshot.walletType || 'N/A';
    document.getElementById('isWhale').textContent = snapshot.isWhale ? 'Yes' : 'No';
    document.getElementById('walletTotalValue').textContent = `$${Number(snapshot.totalValue).toLocaleString()}`;

    // âœ… Show breakdown for reference
    document.getElementById('strategyInsights').textContent =
      `On-chain: $${snapshot.breakdown.onChain.toFixed(2)}, DeFi: $${snapshot.breakdown.defi.toFixed(2)}`;

    // âœ… PnL
    const pnlRes = await fetch(`/api/wallet/${wallet}/pnl`);
    const pnlData = await pnlRes.json();
    document.getElementById('walletPnL').textContent = `${pnlData.pnl}%`;

    // âœ… Portfolio
    const portfolioRes = await fetch(`/api/wallet/${wallet}/portfolio`);
    const portfolio = await portfolioRes.json();
    const pnlList = document.getElementById('pnlByAssetList');
    pnlList.innerHTML = portfolio.map(token => `
      <li>${token.name}: $${token.value} (${token.balance})</li>
    `).join('');

    // âœ… Strategy Insights
    if (snapshot.isWhale) {
      document.getElementById('strategyInsights').textContent =
        'Whale detected: Likely a long-term holder or institutional wallet.';
    } else if (portfolio.length > 5) {
      document.getElementById('strategyInsights').textContent =
        'Diverse portfolio: Likely DeFi or farming strategy.';
    }

  } catch (error) {
    console.error(error);
    alert('Failed to fetch wallet analytics');
  }
});
</script>
</body>
</html>
